"use strict";angular.module("emapsApp",["ngAnimate","ngCookies","ngResource","ngRoute","ngSanitize","ngTouch","ui.bootstrap","angular-loading-bar","angulartics","angulartics.google.analytics"]).config(["$routeProvider","$locationProvider",function(a,b){b.hashPrefix("!"),a.when("/",{redirectTo:"/home"}).when("/home",{templateUrl:"views/main.html",controller:"MainCtrl",resolve:{narratives:["fileService",function(a){return a.getFile("contents/narratives.json")}],maps:["fileService",function(a){return a.getFile("contents/maps.json")}],content:["fileService",function(a){return a.getFile("contents/pages/home.json")}]}}).when("/narrative/:narrative",{templateUrl:"views/narrative.html",controller:"NarrativeCtrl",resolve:{content:["$route","fileService",function(a,b){var c=a.current.params.narrative;return b.getFile("contents/narratives/"+c+".json")}],narratives:["fileService",function(a){return a.getFile("contents/narratives.json")}]}}).when("/map/:map",{templateUrl:"views/map.html",controller:"MapCtrl",resolve:{content:["$route","fileService",function(a,b){var c=a.current.params.map;return b.getFile("contents/maps/"+c+".json")}],narratives:["fileService",function(a){return a.getFile("contents/narratives.json")}],maps:["fileService",function(a){return a.getFile("contents/maps.json")}]}}).when("/controversy-mapping",{templateUrl:"views/theory.html",controller:"TheoryCtrl",resolve:{content:["fileService",function(a){return a.getFile("contents/pages/controversy-mapping.json")}]}}).when("/foreword",{templateUrl:"views/foreword.html",controller:"ForewordCtrl",resolve:{content:["fileService",function(a){return a.getFile("contents/pages/a-foreword-for-emaps.json")}]}}).when("/sprints",{templateUrl:"views/sprints.html",controller:"SprintsCtrl",resolve:{content:["fileService",function(a){return a.getFile("contents/pages/sprint.json")}]}}).when("/datasets",{templateUrl:"views/datasets.html",controller:"DatasetsCtrl",resolve:{content:["fileService",function(a){return a.getFile("contents/pages/datasets.json")}]}}).when("/about",{templateUrl:"views/about.html",controller:"AboutCtrl",resolve:{content:["fileService",function(a){return a.getFile("contents/pages/about-the-project.json")}],institutions:["fileService",function(a){return a.getFile("contents/pages/institutions.json")}],authors:["fileService",function(a){return a.getFile("contents/pages/authors.json")}]}}).otherwise({redirectTo:"/"})}]).run(["$rootScope","$route","$location","$window","$timeout","$anchorScroll","$animate",function(a,b,c,d,e,f){a.$on("$locationChangeSuccess",function(){a.actualLocation=c.path()}),a.$watch(function(){return c.path()},function(b){a.actualLocation!==b&&e(function(){c.hash()?f():d.scrollTo(0,0)})})}]),angular.module("emapsApp").controller("MainCtrl",["$routeParams","$anchorScroll","$location","$scope","$timeout","narratives","maps","content",function(a,b,c,d,e,f,g,h){d.narratives=f.sort(function(a,b){return b.title<a.title?1:-1}),d.maps=g.sort(function(a,b){return b.title<a.title?1:-1}),d.content=h,d.tabs=[{name:"Issue stories",active:"stories"!==c.hash()&&c.hash()?!1:!0},{name:"Issue maps",active:"maps"===c.hash()?!0:!1}]}]),angular.module("emapsApp").controller("AboutCtrl",["$scope","content","institutions","authors",function(a,b,c,d){a.content=b,a.institutions=c,a.authors=d}]),angular.module("emapsApp").controller("NarrativeCtrl",["$scope","content","narratives",function(a,b,c){a.narratives=c,a.filterLinks=function(b){var c=/href="https:\/\/drive\.google\.com.+?id=(.+?)&amp.+"/g;return c.test(b)&&(b=b.replace(c,function(b,c){var d=a.narratives.filter(function(a){return a.id==c})[0].slug;return"href='#!/narrative/"+d+"'"})),b},b.sections.forEach(function(b){b.html=a.filterLinks(b.html)}),a.content=b}]),angular.module("emapsApp").controller("MapCtrl",["$scope","$compile","$timeout","content","narratives","maps",function(a,b,c,d,e,f){function g(a){for(var b=/>https:\/\/drive\.google\.com.+?id=(.+?)(<|&|;|")/g,c=[],d=b.exec(a);null!=d;)c.push(d[1]),d=b.exec(a);return c}a.content=d,a.narratives=e,a.maps=f,a.relatedMaps=[],a.relatedNarratives=[],a.content.metadata.forEach(function(b){if("Related maps"===b.title){var c=g(b.html);c.forEach(function(b){var c=a.maps.filter(function(a){return b===a.id})[0];a.relatedMaps.push({title:c.title,slug:c.slug})})}if("Related narratives"===b.title){var c=g(b.html);c.forEach(function(b){var c=a.narratives.filter(function(a){return b===a.id})[0];a.relatedNarratives.push({title:c.title,slug:c.slug})})}})}]),angular.module("emapsApp").controller("TheoryCtrl",["$scope","content","$location",function(a,b){a.content=b}]),angular.module("emapsApp").controller("SprintsCtrl",["$scope","content",function(a,b){a.content=b}]),angular.module("emapsApp").factory("fileService",["$http","$q",function(a,b){return{getFile:function(c){var d=b.defer();return a.get(c,{cache:!0}).success(function(a){d.resolve(a)}).error(function(){d.reject("An error occured while fetching file")}),d.promise}}}]),angular.module("emapsApp").directive("bilateralFunds",["fileService","$compile",function(a,b){return{replace:!1,restrict:"A",link:function(c,d,e){var f=d3.select(d[0]).append("div").attr("class","container").append("div").attr("class","row").append("div").attr("class","col-md-12 single-container");a.getFile(JSON.parse(e.directiveData)[0].url).then(function(a){f.html(a);var e=f.select("#Layer_2").selectAll("rect");e.attr("tooltip",function(){var a=d3.select(this).select("title").text();return d3.select(this).datum(a),a}).attr("tooltip-append-to-body","true").attr("tooltip-placement","left").on("mouseover",function(a){var b=a;e.attr("opacity",function(a){var c=a;return b===c?1:.3})}).on("mouseout",function(){e.attr("opacity",function(){return 1})}),b(angular.element(d.find("svg")))(c)},function(a){var b=a;d.html(b)})}}}]),angular.module("emapsApp").directive("directiveManager",["$compile",function(a){return{restrict:"A",replace:!0,link:function(b,c,d){var e=d.directiveName,f=d.directiveData,g="<div directive-data='"+f+"'"+e+"></div>",h=angular.element(g);c.append(h),a(h)(b)}}}]),angular.module("emapsApp").directive("static",["fileService",function(a){return{replace:!1,restrict:"A",link:function(b,c,d){var e=d3.select(c[0]).append("div").attr("class","container").append("div").attr("class","row").append("div").attr("class","col-md-12 single-container"),f=JSON.parse(d.directiveData)[0].url.split(".");return f=f[f.length-1].toLowerCase(),"jpg"===f||"png"===f?void e.append("img").attr("src",JSON.parse(d.directiveData)[0].url):void a.getFile(JSON.parse(d.directiveData)[0].url).then(function(a){e.html(a)},function(a){var b=a;e.html(b)})}}}]),angular.module("emapsApp").directive("network",["fileService",function(a){return{restrict:"A",replace:!1,templateUrl:"views/network.html",link:function(b,c,d){b.isCollapsed=!0;var e=c.find("#sigma-container")[0],f=d3.select(c[0]),g=d3.select(e),h=emaps.graph().on("filtered",function(a){a.nodeID?(b.selectedNode=a.nodes.filter(function(a){return a.selected})[0],h.centerView(b.selectedNode),b.attrs=d3.entries(b.selectedNode.attributes),b.linkedNodes=a.nodes.filter(function(a){return!a.selected}),b.edges=i(a.nodeID,a.edges),b.isCollapsed=!1,b.$$phase||b.$apply()):(b.selected=void 0,b.isCollapsed=!0,b.$$phase||b.$apply())});b.indexes=JSON.parse(d.directiveData),b.index=b.indexes[0],b.updateNetwork=function(a){g.call(h.setSelectedNode(a.id))};var i=function(a,b){var c={},d={},e={};b.forEach(function(b){a===b.source?c[b.id]=b:a===b.target&&(d[b.id]=b)});for(var f in c)f in d&&(e[f]=c[f],delete d[f],delete c[f]);return{outgoing:d3.values(c),incoming:d3.values(d),mutual:d3.values(e)}};f.select("#in").on("click",function(){h.zoomIn()}),f.select("#out").on("click",function(){h.zoomOut()}),f.select("#reset").on("click",function(){h.zoomReset()});var j=function(d){var e=d.label;a.getFile(d.url).then(function(a){b.bipartite=a.settings.bipartite,b.nodes=a.nodes,b.nodesLabel=function(a){var c=b.nodes.filter(function(b){return b.id===a});return c[0]},b.selected=void 0,b.isCollapsed=!0,b.bipartite||(b.linksLegend={outgoing:a.settings.outgoing,incoming:a.settings.incoming,mutual:a.settings.mutual});var c={labelThreshold:a.settings.labelThreshold,font:"Source Sans Pro",mouseWheelEnabled:!1};h.settings(c),h.label(e),g.datum(a).call(h),h.zoomReset()},function(a){var b=a;c.html(b)})};j(b.index),b.$watch("index",function(a,b){var c=angular.equals(a,b);c||j(a)})}}}]),angular.module("emapsApp").directive("mentions",["fileService","$compile",function(a,b){return{replace:!1,restrict:"A",link:function(c,d,e){var f=d3.select(d[0]).append("div").attr("class","container").append("div").attr("class","row").append("div").attr("class","col-md-12 single-container");a.getFile(JSON.parse(e.directiveData)[0].url).then(function(a){f.html(a);var e=d3.select(d[0]).select("#interactive").selectAll("g");e.attr("tooltip",function(){var a=d3.select(this).select("title").text();return a}).attr("tooltip-append-to-body","true").attr("tooltip-placement","top"),b(angular.element(d.find("svg")))(c)},function(a){var b=a;d.html(b)})}}}]),angular.module("emapsApp").directive("scatterfund",["fileService",function(a){return{replace:!1,restrict:"A",templateUrl:"views/scatterfund.html",link:function(b,c,d){var e=c.find("#scatterfund-container").width(),f=c.find("#scatterfund-container")[0],g=d3.select(f),h=emaps.scatterplot().width(e).height(600).sizeField("Total").xField("Germanwatch_inverse").yField("Total").frogeggs(["Adaptation_Fund","LDC_Fund","Pilot_programme","Special_Climate_Change_Fund"]).labelField("Country").colorField("Germanwatch_inverse").colorArray(["#95A565","#EFC164","#FF5A52"]);b.indexes=["Germanwatch_inverse","Dara_inverse","Gain_inverse","Human_Development_Index"],b.index=b.indexes[0],b.fundModel={Adaptation_Fund:!0,LDC_Fund:!0,Pilot_programme:!0,Special_Climate_Change_Fund:!0},a.getFile(JSON.parse(d.directiveData)[0].url).then(function(a){var b=d3.csv.parse(a);g.datum(b).call(h)},function(a){var b=a;c.text(b)}),b.$watch("index",function(a,b){a!==b&&(h.xField(a).colorField(a),g.call(h))}),b.$watchCollection("fundModel",function(a,b){var c=angular.equals(a,b);if(!c){var d=d3.entries(a).filter(function(a){return a.value===!0}).map(function(a){return a.key});h.frogeggs(d),g.call(h)}})}}}]),angular.module("emapsApp").directive("dna",["fileService","$compile",function(a,b){return{replace:!1,restrict:"A",link:function(c,d,e){var f=d3.select(d[0]).append("div").attr("class","container").append("div").attr("class","row").append("div").attr("class","col-md-12 single-container");a.getFile(JSON.parse(e.directiveData)[0].url).then(function(a){f.html(a);var e=f.select("#interactive").selectAll("rect").attr("col-val",function(){var a=d3.select(this).attr("fill");return void 0===a?0:a}).style("stroke-opacity",1);e.attr("tooltip",function(){var a=d3.select(this).select("title").text();return a}).attr("tooltip-append-to-body","true").attr("tooltip-placement","top"),e.on("mouseover",function(){var a=d3.select(this).select("title").text();e.transition().duration(200).style("fill",function(){var b=d3.select(this).select("title").text();return a!==b?d3.select(this).attr("col-val"):"#FF5A52"}).style("stroke",function(){var b=d3.select(this).select("title").text();return a!==b?"none":"#FF5A52"})}),e.on("mouseout",function(){e.transition().duration(200).style("fill",function(){return d3.select(this).attr("col-val")}).style("stroke",function(){return"none"})}),b(angular.element(d.find("svg")))(c)},function(a){var b=a;d.html(b)})}}}]),angular.module("emapsApp").directive("treemention",["fileService","$compile",function(a,b){return{replace:!1,restrict:"A",link:function(c,d,e){var f=d3.select(d[0]).append("div").attr("class","container").append("div").attr("class","row").append("div").attr("class","col-md-12 single-container");a.getFile(JSON.parse(e.directiveData)[0].url).then(function(a){f.html(a);var e=f.select("#interactive").selectAll("rect");e.attr("tooltip",function(){var a=d3.select(this).select("title").text();return a}).attr("tooltip-append-to-body","true").attr("tooltip-placement","left"),b(angular.element(d.find("svg")))(c)},function(a){var b=a;d.html(b)})}}}]),angular.module("emapsApp").directive("multiplestatic",["fileService","$compile",function(a,b){return{restrict:"A",templateUrl:"views/multiplestatic.html",link:function(c,d,e){c.indexes=JSON.parse(e.directiveData),c.index=c.indexes[0],c.container=d.find("#multiple-container"),c.$watch("index",function(e){var f=e.url.split(".");return f=f[f.length-1].toLowerCase(),"jpg"===f||"png"===f?(c.container.find("img").remove(),void c.container.append('<img src="'+e.url+'"/>').attr("src",e.url)):void a.getFile(e.url).then(function(a){function e(a){a.attr("tooltip",function(){var a=d3.select(this).select("title").text();return a}).attr("tooltip-append-to-body","true").attr("tooltip-placement","left"),a.on("mouseover",function(){d3.select(this).select("title").text()}),a.on("mouseout",function(){}),b(angular.element(d.find("svg")))(c)}c.container.html(a);var f=d3.select(c.container[0]).select("#interactive").selectAll("circle").filter(function(){return d3.select(this).select("title").length>0?!0:!1});e(f);var g=d3.select(c.container[0]).select("#interactive").selectAll("rect").filter(function(){return d3.select(this).select("title").length>0?!0:!1});e(g)},function(a){var b=a;c.container.html(b)})})}}}]),angular.module("emapsApp").directive("menu",function(){return{templateUrl:"views/menu.html",restrict:"A",replace:"false",link:function(a,b){b.find("#menu-ico").click(function(a){a.preventDefault(),$(this).toggleClass("on"),$(this).hasClass("on")?b.find(".hidden-menu").removeClass("out"):b.find(".hidden-menu").addClass("out")}),b.find("li a").click(function(){b.find(".hidden-menu").addClass("out"),b.find("#menu-ico").removeClass("on")})}}}),angular.module("emapsApp").directive("narrative3Map2",["fileService",function(fileService){return{templateUrl:"views/narrative3_map2.html",replace:!1,restrict:"A",link:function postLink(scope,element,attrs){scope.indexes=[{value:"source",label:"source"},{value:"recipient_mapped",label:"country"},{value:"year",label:"year"},{value:"donor",label:"donor"},{value:"purpose",label:"purpose"},{value:"sector",label:"sector"},{value:"sector_mapped",label:"sectors in undp alm scheme"}],scope.xindex=scope.indexes[1],scope.yindex=scope.indexes[2],scope.source="recipient_mapped",scope.dataset="substance_of_adaptation.json",scope.orderby="alphabet",scope.source=scope.xindex.value,scope.target=scope.yindex.value,scope.whichdata="indiabangladesh",scope.data=[],scope.el=d3.select(element[0]).select("#matrix-container"),scope.filter="",scope.sort="alphabet",scope.filt="indiabangladesh",fileService.getFile(JSON.parse(attrs.directiveData)[0].url).then(function(a){scope.data=a,scope.drawChart(scope.orderby,scope.source,scope.target,scope.filter)},function(a){var b=a;element.text(b)}),scope.$watch("yindex",function(a,b){a!==b&&(scope.target=a.value,scope.drawChart(scope.orderby,scope.source,scope.target,scope.filter))}),scope.$watch("xindex",function(a,b){a!==b&&(scope.source=a.value,scope.drawChart(scope.orderby,scope.source,scope.target,scope.filter))}),scope.$watch("sort",function(a,b){a!==b&&(scope.orderby=a,scope.drawChart(scope.orderby,scope.source,scope.target,scope.filter))}),scope.$watch("filt",function(a,b){a!==b&&(scope.whichdata=a,scope.drawChart(scope.orderby,scope.source,scope.target,scope.filter))}),scope.drawChart=function(orderby,source,target,filter){function nodeIndex(a,b){var c;for(c=0;c<b.length;c++)if(b[c].name==a)return c;return-1}function linkIndex(a,b,c){var d;for(d=0;d<c.length;d++)if(c[d].source==a&&c[d].target==b)return d;return-1}function row(a){d3.select(this).selectAll(".bg").data(a).enter().append("rect").attr("class","bg").attr("x",function(a){return x(a.x)}).attr("y",function(a){return y(a.y)/2}).attr("width",function(){return x.rangeBand()-5}).attr("height",10).style("fill",function(){return"rgba(120, 120, 120)"}).style("opacity",.1),d3.select(this).selectAll(".cell").data(a.filter(function(a){return a.z})).enter().append("rect").attr("class","cell").attr("x",function(a){return x(a.x)}).attr("y",function(a){return y(a.y)/2}).attr("width",function(a){return z(a.z)*(x.rangeBand()-5)}).attr("height",10).style("fill",function(){return"rgb(40, 98, 117)"}).style("opacity",.7).on("mouseover",mouseover).on("mouseout",mouseout).append("svg:title").text(function(a){return a.z+" * ("+sources[a.x].name+" + "+targets[a.y].name+")"})}function mouseover(a){d3.select(this).classed("mat-sel",!0),d3.selectAll(".row text").classed("active",function(b,c){return c==a.y}),d3.selectAll(".column text").classed("active",function(b,c){return c==a.x})}function mouseout(){d3.select(this).classed("mat-sel",!1),d3.selectAll("text").classed("active",!1)}scope.el.select("svg").remove();var margin={top:140,right:140,bottom:10,left:250},width=820,height=2e3,x=d3.scale.ordinal().rangeBands([0,width]),nodes=[],links=[],sources=[],targets=[];scope.data.forEach(function(d,i){if(""==scope.filter||d.source==scope.filter){if(-1==source.indexOf("."))var dsources=d[source];else var dsources=eval("d."+source);if(-1==target.indexOf("."))var dtargets=d[target];else var dtargets=eval("d."+target);if(""!==dsources&&""!==dtargets){if(dsources instanceof Array||(dsources=[dsources]),dtargets instanceof Array||(dtargets=[dtargets]),"indiabangladesh"==scope.whichdata){if("countries"in d&&"Bangladesh"!=d.countries&&"India"!=d.countries)return;if("country"in d&&"Bangladesh"!=d.country&&"India"!=d.country)return;if("recipientnameE"in d&&"Bangladesh"!=d.recipientnameE&&"India"!=d.recipientnameE)return;if("recipient"in d&&"Bangladesh"!=d.recipient&&"India"!=d.recipient)return;if("recipientMapped"in d&&"Bangladesh"!=d.recipientMapped&&"India"!=d.recipientMapped)return}dsources.forEach(function(a){if(a=a.trim(),"Non-specific"!=a){var b=nodeIndex(a,sources);0>b&&(sources.push({name:a}),b=nodeIndex(a,sources)),dtargets.forEach(function(a){if(a=a.trim(),"Non-specific"!=a){var c=nodeIndex(a,targets);0>c&&(targets.push({name:a}),c=nodeIndex(a,targets));var d=linkIndex(b,c,links);0>d?links.push({source:b,target:c,value:1}):links[d].value++}})}})}}});var matrix=[],ntargets=targets.length,nsources=sources.length;targets.forEach(function(a,b){a.count=0,matrix[b]=d3.range(nsources).map(function(a){return sources[a].count=0,{x:a,y:b,z:0}})});var max=0;links.forEach(function(a){matrix[a.target][a.source].z+=a.value,max<a.value&&(max=a.value),targets[a.target].count+=a.value,sources[a.source].count+=a.value});var y=d3.scale.ordinal().rangeBands([0,11*ntargets]),z=d3.scale.linear().domain([0,max]),sourceOrders={name:d3.range(nsources).sort(function(a,b){return d3.ascending(sources[a].name,sources[b].name)}),count:d3.range(nsources).sort(function(a,b){return d3.descending(sources[a].count,sources[b].count)})},targetOrders={name:d3.range(ntargets).sort(function(a,b){return d3.ascending(targets[a].name,targets[b].name)}),count:d3.range(ntargets).sort(function(a,b){return d3.descending(targets[a].count,targets[b].count)})};"count"==orderby?(x.domain(sourceOrders.count),y.domain(targetOrders.count)):(x.domain(sourceOrders.name),y.domain(targetOrders.name)),height=11*ntargets+20;var svg=scope.el.append("svg").attr("width",width+margin.left+margin.right).attr("height",height+margin.top+margin.bottom).append("g").attr("transform","translate("+margin.left+","+margin.top+")"),row=svg.selectAll(".row").data(matrix).enter().append("g").attr("class","row").attr("transform",function(a,b){return"translate(0,"+y(b)/2+")"}).each(row);row.append("text").attr("x",-6).attr("y",5).attr("dy",".12em").attr("transform",function(a,b){return"translate(0,"+(y(b)+2)/2+")"}).attr("text-anchor","end").text(function(a,b){return targets[b].name.length>50?targets[b].name.substr(0,50)+"…":targets[b].name});var column=svg.selectAll(".column").data(sources).enter().append("g").attr("class","column").attr("transform",function(a,b){return"translate("+x(b)+",-10)rotate(-30)"});column.append("text").attr("x",6).attr("y",2.5).attr("dy",".32em").attr("text-anchor","start").text(function(a){return a.name.length>30?a.name.substr(0,30)+"…":a.name})}}}}]),angular.module("emapsApp").directive("narrative3Map10a",["fileService",function(a){return{replace:!1,restrict:"A",link:function(b,c,d){var e=d3.select(c[0]).append("div").attr("class","container").append("div").attr("class","row").append("div").attr("class","col-md-12 single-container");a.getFile(JSON.parse(d.directiveData)[0].url).then(function(a){e.html(a);var b=e.select("#interactive").selectAll("path"),c=e.select("#interactive").selectAll("g");b.on("mouseover",function(){var a=d3.select(this).node().parentNode,b=d3.select(a).attr("id");c.transition().duration(200).attr("opacity",function(){var a=d3.select(this).attr("id");return a?b==a?1:.3:void 0})}),b.on("mouseout",function(){c.transition().duration(200).attr("opacity",function(){var a=d3.select(this).attr("id");return a?1:void 0})})})}}}]),angular.module("emapsApp").directive("imageManager",function(){return{template:"<div></div>",restrict:"E",link:function(a,b){b.text("this is the imageManager directive")}}}),angular.module("emapsApp").directive("narrative3Map22",["fileService",function(fileService){return{templateUrl:"views/narrative3_map2.html",replace:!1,restrict:"A",link:function postLink(scope,element,attrs){scope.indexes=[{value:"source",label:"source"},{value:"recipient_mapped",label:"country"},{value:"year",label:"year"},{value:"donor",label:"donor"},{value:"purpose",label:"purpose"},{value:"sector",label:"sector"},{value:"sector_mapped",label:"sectors in undp alm scheme"}],scope.xindex=scope.indexes[1],scope.yindex=scope.indexes[4],scope.dataset="substance_of_adaptation.json",scope.orderby="count",scope.source=scope.xindex.value,scope.target=scope.yindex.value,scope.whichdata="indiabangladesh",scope.data=[],scope.el=d3.select(element[0]).select("#matrix-container"),scope.filter="",scope.sort="count",scope.filt="indiabangladesh",fileService.getFile(JSON.parse(attrs.directiveData)[0].url).then(function(a){scope.data=a,scope.drawChart(scope.orderby,scope.source,scope.target,scope.filter)},function(a){var b=a;element.text(b)}),scope.$watch("yindex",function(a,b){a!==b&&(scope.target=a.value,scope.drawChart(scope.orderby,scope.source,scope.target,scope.filter))}),scope.$watch("xindex",function(a,b){a!==b&&(scope.source=a.value,scope.drawChart(scope.orderby,scope.source,scope.target,scope.filter))}),scope.$watch("sort",function(a,b){a!==b&&(scope.orderby=a,scope.drawChart(scope.orderby,scope.source,scope.target,scope.filter))}),scope.$watch("filt",function(a,b){a!==b&&(scope.whichdata=a,scope.drawChart(scope.orderby,scope.source,scope.target,scope.filter))}),scope.drawChart=function(orderby,source,target,filter){function nodeIndex(a,b){var c;for(c=0;c<b.length;c++)if(b[c].name==a)return c;return-1}function linkIndex(a,b,c){var d;for(d=0;d<c.length;d++)if(c[d].source==a&&c[d].target==b)return d;return-1}function row(a){d3.select(this).selectAll(".bg").data(a).enter().append("rect").attr("class","bg").attr("x",function(a){return x(a.x)}).attr("y",function(a){return y(a.y)/2}).attr("width",function(){return x.rangeBand()-5}).attr("height",10).style("fill",function(){return"rgba(120, 120, 120)"}).style("opacity",.1),d3.select(this).selectAll(".cell").data(a.filter(function(a){return a.z})).enter().append("rect").attr("class","cell").attr("x",function(a){return x(a.x)}).attr("y",function(a){return y(a.y)/2}).attr("width",function(a){return z(a.z)*(x.rangeBand()-5)}).attr("height",10).style("fill",function(){return"rgb(40, 98, 117)"}).style("opacity",.7).on("mouseover",mouseover).on("mouseout",mouseout).append("svg:title").text(function(a){return a.z+" * ("+sources[a.x].name+" + "+targets[a.y].name+")"})}function mouseover(a){d3.select(this).classed("mat-sel",!0),d3.selectAll(".row text").classed("active",function(b,c){return c==a.y}),d3.selectAll(".column text").classed("active",function(b,c){return c==a.x})}function mouseout(){d3.select(this).classed("mat-sel",!1),d3.selectAll("text").classed("active",!1)}scope.el.select("svg").remove();var margin={top:140,right:140,bottom:10,left:250},width=820,height=2e3,x=d3.scale.ordinal().rangeBands([0,width]),nodes=[],links=[],sources=[],targets=[];scope.data.forEach(function(d,i){if(""==scope.filter||d.source==scope.filter){if(-1==source.indexOf("."))var dsources=d[source];else var dsources=eval("d."+source);if(-1==target.indexOf("."))var dtargets=d[target];else var dtargets=eval("d."+target);if(""!==dsources&&""!==dtargets){if(dsources instanceof Array||(dsources=[dsources]),dtargets instanceof Array||(dtargets=[dtargets]),"indiabangladesh"==scope.whichdata){if("countries"in d&&"Bangladesh"!=d.countries&&"India"!=d.countries)return;if("country"in d&&"Bangladesh"!=d.country&&"India"!=d.country)return;if("recipientnameE"in d&&"Bangladesh"!=d.recipientnameE&&"India"!=d.recipientnameE)return;if("recipient"in d&&"Bangladesh"!=d.recipient&&"India"!=d.recipient)return;if("recipientMapped"in d&&"Bangladesh"!=d.recipientMapped&&"India"!=d.recipientMapped)return}dsources.forEach(function(a){if(a=a.trim(),"Non-specific"!=a){var b=nodeIndex(a,sources);0>b&&(sources.push({name:a}),b=nodeIndex(a,sources)),dtargets.forEach(function(a){if(a=a.trim(),"Non-specific"!=a){var c=nodeIndex(a,targets);0>c&&(targets.push({name:a}),c=nodeIndex(a,targets));var d=linkIndex(b,c,links);0>d?links.push({source:b,target:c,value:1}):links[d].value++}})}})}}});var matrix=[],ntargets=targets.length,nsources=sources.length;targets.forEach(function(a,b){a.count=0,matrix[b]=d3.range(nsources).map(function(a){return sources[a].count=0,{x:a,y:b,z:0}})});var max=0;links.forEach(function(a){matrix[a.target][a.source].z+=a.value,max<a.value&&(max=a.value),targets[a.target].count+=a.value,sources[a.source].count+=a.value});var y=d3.scale.ordinal().rangeBands([0,11*ntargets]),z=d3.scale.linear().domain([0,max]),sourceOrders={name:d3.range(nsources).sort(function(a,b){return d3.ascending(sources[a].name,sources[b].name)}),count:d3.range(nsources).sort(function(a,b){return d3.descending(sources[a].count,sources[b].count)})},targetOrders={name:d3.range(ntargets).sort(function(a,b){return d3.ascending(targets[a].name,targets[b].name)}),count:d3.range(ntargets).sort(function(a,b){return d3.descending(targets[a].count,targets[b].count)})};"count"==orderby?(x.domain(sourceOrders.count),y.domain(targetOrders.count)):(x.domain(sourceOrders.name),y.domain(targetOrders.name)),height=11*ntargets+20;var svg=scope.el.append("svg").attr("width",width+margin.left+margin.right).attr("height",height+margin.top+margin.bottom).append("g").attr("transform","translate("+margin.left+","+margin.top+")"),row=svg.selectAll(".row").data(matrix).enter().append("g").attr("class","row").attr("transform",function(a,b){return"translate(0,"+y(b)/2+")"}).each(row);row.append("text").attr("x",-6).attr("y",5).attr("dy",".12em").attr("transform",function(a,b){return"translate(0,"+(y(b)+2)/2+")"}).attr("text-anchor","end").text(function(a,b){return targets[b].name.length>50?targets[b].name.substr(0,50)+"…":targets[b].name});var column=svg.selectAll(".column").data(sources).enter().append("g").attr("class","column").attr("transform",function(a,b){return"translate("+x(b)+",-10)rotate(-30)"});column.append("text").attr("x",6).attr("y",2.5).attr("dy",".32em").attr("text-anchor","start").text(function(a){return a.name.length>30?a.name.substr(0,30)+"…":a.name})}}}}]),angular.module("emapsApp").directive("narrative5Map25a",["fileService",function(a){return{replace:!1,restrict:"A",templateUrl:"views/narrative5_map25a.html",link:function(b,c,d){function e(){var a=g.filter(function(a){return a.Donor===b.sel})[0];j.selectAll(".rec").remove(),h=d3.values(a).slice(1,a.length),j.select("h2").text(a.Donor),j.selectAll(".rec").data(h).enter().append("div").attr("class","rec").text(function(a){return a})}var f,g;b.sel=null;var h,i=d3.select(c[0]).select("#scatter-container"),j=d3.select(c[0]).select(".top5");a.getFile(JSON.parse(d.directiveData)[1].url).then(function(a){g=d3.csv.parse(a)}),a.getFile(JSON.parse(d.directiveData)[0].url).then(function(a){var d=d3.csv.parse(a);f=emaps.scatterplot().width(c.find("#scatter-container").width()).height(600).sizeField("amount").xField("purposes").yField("recipients").labelField("donor").colorField(null).colorArray(["#ddd"]),i.datum(d).call(f),i.selectAll("circle").on("click",function(a){i.selectAll(".scat-sel").classed("scat-sel",!1),d3.select(this).classed("scat-sel",!0),b.sel=a.donor,e()})})}}}]),angular.module("emapsApp").directive("narrative6Map30",["fileService",function(a){return{replace:!1,restrict:"A",templateUrl:"views/multiplestatic.html",link:function(b,c,d){b.indexes=JSON.parse(d.directiveData),b.index=b.indexes[0],b.container=d3.select(c[0]).select("#multiple-container"),b.$watch("index",function(c){a.getFile(c.url).then(function(a){b.container.html(a);var c=b.container.select("#interactive").selectAll("path");c.on("mouseover",function(){b.container.select("#interactive").selectAll("path").transition().duration(300).style("opacity",.3),b.container.select("#interactive").selectAll("text").transition().duration(300).style("opacity",.3),d3.select(this).transition().duration(300).style("opacity",1),d3.select(this.parentNode).select("text").transition().duration(300).style("opacity",1)}),c.on("mouseout",function(){b.container.select("#interactive").selectAll("path").transition().duration(300).style("opacity",.7),b.container.select("#interactive").selectAll("text").transition().duration(300).style("opacity",1)})})})}}}]),angular.module("emapsApp").controller("ForewordCtrl",["$scope","content",function(a,b){a.content=b}]),angular.module("emapsApp").directive("map14",["fileService","$compile",function(a,b){return{replace:!1,restrict:"A",templateUrl:"views/map14.html",link:function(c,d,e){var f,g,h=d3.select(d[0]).select("#matrix14-container"),i=function(){var a=$(this).attr("data"),e=$(this).attr("class"),j=null;e.indexOf("sort")>-1||e.indexOf("s-up")>-1?j="descending":e.indexOf("s-down")>-1&&(j="ascending"),f.sortFields([a]).sortOrder(j),h.datum(g).call(f),b(angular.element(d.find("svg")))(c),h.selectAll(".xlabel").on("click",i)};a.getFile(JSON.parse(e.directiveData)[0].url).then(function(a){g=d3.csv.parse(a),f=emaps.matrix().width(d.find("#matrix14-container").width()).height(800).yField("item").xField(["ALL","CCVI","CVM","GAIN","CRI","CCPI","DICE","HDI","VASS"]).normalization("whole").colorField(null).selColor("B0CFCD").matrixStyle("bars").colorArray("#286275"),h.datum(g).call(f),b(angular.element(d.find("svg")))(c),h.selectAll(".xlabel").on("click",i)})}}}]),angular.module("emapsApp").directive("multiplestaticfluid",["fileService","$compile",function(a,b){return{restrict:"A",templateUrl:"views/multiplestaticfluid.html",link:function(c,d,e){c.indexes=JSON.parse(e.directiveData),c.index=c.indexes[0],c.container=d.find("#multiple-container-fluid"),c.$watch("index",function(e){var f=e.url.split(".");return f=f[f.length-1].toLowerCase(),"jpg"===f||"png"===f?void c.container.append("img").attr("src",e.url):void a.getFile(e.url).then(function(a){function e(a){a.attr("tooltip",function(){var a=d3.select(this).select("title").text();return a}).attr("tooltip-append-to-body","true").attr("tooltip-placement","left"),a.on("mouseover",function(){d3.select(this).select("title").text()}),a.on("mouseout",function(){}),b(angular.element(d.find("svg")))(c)}c.container.html(a);var f=d3.select(c.container[0]).select("#interactive").selectAll("circle").filter(function(){return d3.select(this).select("title").length>0?!0:!1});e(f);var g=d3.select(c.container[0]).select("#interactive").selectAll("rect").filter(function(){return d3.select(this).select("title").length>0?!0:!1});e(g)},function(a){var b=a;c.container.html(b)})})}}}]),angular.module("emapsApp").directive("map7",["fileService","$timeout","$q",function(fileService,$timeout,$q){return{templateUrl:"views/map7.html",replace:!1,restrict:"A",compile:function compile(tElement,tAttributes){return{pre:function(){},post:function postLink(scope,element,attrs){function loadData(){JSON.parse(attrs.directiveData).forEach(function(a,b){fileService.getFile(a.url).then(function(a){0==b&&(scope.data=a),scope.datafiles.push(a),scope.datafiles.length==JSON.parse(attrs.directiveData).length&&showMap()
})})}function showMap(){scope.datasets=[{filter:"undp",fieldSet:[{value:"themes",label:"sectors"},{value:"countries",label:"countries"},{value:"climate-hazards",label:"climate hazards"},{value:"key-collaborators",label:"key collaborators"}],name:"UNDP",dataset:"adaptation_projects.json"},{filter:"psi",fieldSet:[{value:"themes",label:"sectors"},{value:"countries",label:"countries"},{value:"climate-hazards",label:"climate hazards"},{value:"key-collaborators",label:"key collaborators"}],name:"PSI",dataset:"adaptation_projects.json"},{filter:"climatewise",fieldSet:[{value:"themes",label:"sectors"},{value:"countries",label:"countries"},{value:"climate-hazards",label:"climate hazards"},{value:"key-collaborators",label:"key collaborators"}],name:"Climatewise",dataset:"adaptation_projects.json"},{filter:"",fieldSet:[{value:"overview.sector",label:"sectors"},{value:"country",label:"countries"},{value:"types",label:"types"},{value:"scale",label:"scale"},{value:"overview.stimuli",label:"stimuli"},{value:"overview.impacts",label:"impacts"},{value:"project_classification.project_type",label:"project type"},{value:"project_classification.project_status",label:"project status"},{value:"project_classification.running_time",label:"running time"},{value:"project_classification.spatial_scale",label:"spatial scale"},{value:"project_classification.effect_emergence",label:"effect emergence"},{value:"project_classification.effect_persistence",label:"effect persistence"},{value:"problem_solving_capacity_an_reversibility.problem_solving_coverage",label:"problem solving coverage"},{value:"problem_solving_capacity_an_reversibility.reversibility",label:"reversibility"},{value:"responsibilities.initiating_agent",label:"initiating agent"},{value:"responsibilities.executing_agent",label:"executing agent"},{value:"responsibilities.funding_source",label:"funding source"}],name:"Ci-Grasp",dataset:"cigrasp.json"},{filter:"",fieldSet:[{value:"SectorNameE",label:"sectors"},{value:"sector_mapped",label:"sectors in undp alm scheme"},{value:"recipientnameE",label:"recipient countries"},{value:"donornameE",label:"donor countries"},{value:"agencynameE",label:"agency"},{value:"purposename_e",label:"purposes"},{value:"RegionNameE",label:"regions"},{value:"IncomeGroupNameE",label:"income Groups"}],name:"OECD",dataset:"oecd.json"},{filter:"",fieldSet:[{value:"sector",label:"sectors"},{value:"sector_mapped",label:"sectors in undp alm scheme"},{value:"recipient",label:"recipient countries"},{value:"recipient_income_level",label:"Recipient Income Level"},{value:"region",label:"Region"},{value:"donor",label:"Funder"},{value:"implementor",label:"Implementor"}],name:"Climate Funds Update",dataset:"climatefundsupdate.json"},{filter:"",fieldSet:[{value:"sector",label:"sectors"},{value:"sector_mapped",label:"sectors in undp alm scheme"},{value:"recipient",label:"recipient"}],name:"NAPA",dataset:"napa.json"}],scope.d=scope.datasets[0],scope.xindex=scope.d.fieldSet,scope.yindex=scope.d.fieldSet,scope.source=scope.d.fieldSet[0].value,scope.target=scope.d.fieldSet[1].value,scope.dataset=scope.d.dataset,scope.orderby="alphabet",scope.whichdata="indiabangladesh",scope.el=d3.select(element[0]).select("#matrix-container"),scope.filter=scope.d.filter,scope.sort="alphabet",scope.filt="indiabangladesh",$timeout(function(){scope.d=scope.datasets[1]}),scope.drawChart=function(orderby,source,target,filter){function nodeIndex(a,b){var c;for(c=0;c<b.length;c++)if(b[c].name==a)return c;return-1}function linkIndex(a,b,c){var d;for(d=0;d<c.length;d++)if(c[d].source==a&&c[d].target==b)return d;return-1}function row(a){d3.select(this).selectAll(".bg").data(a).enter().append("rect").attr("class","bg").attr("x",function(a){return x(a.x)}).attr("y",function(a){return y(a.y)/2}).attr("width",function(){return x.rangeBand()-5}).attr("height",10).style("fill",function(){return"rgba(120, 120, 120)"}).style("opacity",.1),d3.select(this).selectAll(".cell").data(a.filter(function(a){return a.z})).enter().append("rect").attr("class","cell").attr("x",function(a){return x(a.x)}).attr("y",function(a){return y(a.y)/2}).attr("width",function(a){return z(a.z)*(x.rangeBand()-5)}).attr("height",10).style("fill",function(){return"rgb(40, 98, 117)"}).style("opacity",.7).on("mouseover",mouseover).on("mouseout",mouseout).append("svg:title").text(function(a){return a.z+" * ("+sources[a.x].name+" + "+targets[a.y].name+")"})}function mouseover(a){d3.select(this).classed("mat-sel",!0),d3.selectAll(".row text").classed("active",function(b,c){return c==a.y}),d3.selectAll(".column text").classed("active",function(b,c){return c==a.x})}function mouseout(){d3.select(this).classed("mat-sel",!1),d3.selectAll("text").classed("active",!1)}scope.el.select("svg").remove();var margin={top:140,right:140,bottom:10,left:250},width=820,height=2e3,x=d3.scale.ordinal().rangeBands([0,width]),nodes=[],links=[],sources=[],targets=[];scope.data.forEach(function(d,i){if(""===scope.filter||d.source===scope.filter){if(-1==source.indexOf("."))var dsources=d[source];else var dsources=eval("d."+source);if(-1==target.indexOf("."))var dtargets=d[target];else var dtargets=eval("d."+target);if(""!==dsources&&""!==dtargets){if(dsources instanceof Array||(dsources="cigrasp.json"==scope.dataset?dsources.split(","):[dsources]),dtargets instanceof Array||(dtargets="cigrasp.json"==scope.dataset?dtargets.split(","):[dtargets]),"indiabangladesh"==scope.whichdata){if("countries"in d&&"Bangladesh"!=d.countries&&"India"!=d.countries)return;if("country"in d&&"Bangladesh"!=d.country&&"India"!=d.country)return;if("recipientnameE"in d&&"Bangladesh"!=d.recipientnameE&&"India"!=d.recipientnameE)return;if("recipient"in d&&"Bangladesh"!=d.recipient&&"India"!=d.recipient)return;if("recipientMapped"in d&&"Bangladesh"!=d.recipientMapped&&"India"!=d.recipientMapped)return}dsources.forEach(function(a){if(a=a.trim(),"Non-specific"!=a){var b=nodeIndex(a,sources);0>b&&(sources.push({name:a}),b=nodeIndex(a,sources)),dtargets.forEach(function(a){if(a=a.trim(),"Non-specific"!=a){var c=nodeIndex(a,targets);0>c&&(targets.push({name:a}),c=nodeIndex(a,targets));var d=linkIndex(b,c,links);0>d?links.push({source:b,target:c,value:1}):links[d].value++}})}})}}});var matrix=[],ntargets=targets.length,nsources=sources.length;targets.forEach(function(a,b){a.count=0,matrix[b]=d3.range(nsources).map(function(a){return sources[a].count=0,{x:a,y:b,z:0}})});var max=0;links.forEach(function(a){matrix[a.target][a.source].z+=a.value,max<a.value&&(max=a.value),targets[a.target].count+=a.value,sources[a.source].count+=a.value});var y=d3.scale.ordinal().rangeBands([0,11*ntargets]),z=d3.scale.linear().domain([0,max]),sourceOrders={name:d3.range(nsources).sort(function(a,b){return d3.ascending(sources[a].name,sources[b].name)}),count:d3.range(nsources).sort(function(a,b){return d3.descending(sources[a].count,sources[b].count)})},targetOrders={name:d3.range(ntargets).sort(function(a,b){return d3.ascending(targets[a].name,targets[b].name)}),count:d3.range(ntargets).sort(function(a,b){return d3.descending(targets[a].count,targets[b].count)})};"count"==orderby?(x.domain(sourceOrders.count),y.domain(targetOrders.count)):(x.domain(sourceOrders.name),y.domain(targetOrders.name)),height=11*ntargets+20;var svg=scope.el.append("svg").attr("width",width+margin.left+margin.right).attr("height",height+margin.top+margin.bottom).append("g").attr("transform","translate("+margin.left+","+margin.top+")"),row=svg.selectAll(".row").data(matrix).enter().append("g").attr("class","row").attr("transform",function(a,b){return"translate(0,"+y(b)/2+")"}).each(row);row.append("text").attr("x",-6).attr("y",5).attr("dy",".12em").attr("transform",function(a,b){return"translate(0,"+(y(b)+2)/2+")"}).attr("text-anchor","end").text(function(a,b){return targets[b].name.length>50?targets[b].name.substr(0,50)+"…":targets[b].name});var column=svg.selectAll(".column").data(sources).enter().append("g").attr("class","column").attr("transform",function(a,b){return"translate("+x(b)+",-10)rotate(-30)"});column.append("text").attr("x",6).attr("y",2.5).attr("dy",".32em").attr("text-anchor","start").text(function(a){return a.name.length>30?a.name.substr(0,30)+"…":a.name})},scope.$watch("yindex",function(a,b){a!==b&&(scope.target=a[1],scope.drawChart(scope.orderby,scope.source.value,scope.target.value,scope.filter))}),scope.$watch("source",function(a,b){a!==b&&scope.drawChart(scope.orderby,scope.source.value,scope.target.value,scope.filter)}),scope.$watch("target",function(a,b){a!==b&&scope.drawChart(scope.orderby,scope.source.value,scope.target.value,scope.filter)}),scope.$watch("d",function(a,b){a!==b&&(scope.d=a,scope.xindex=scope.d.fieldSet,scope.yindex=scope.d.fieldSet,scope.data=scope.datafiles.filter(function(b){return b.name===a.dataset})[0].values,scope.dataset=scope.d.dataset,scope.filter=scope.d.filter,scope.drawChart(scope.d,scope.orderby,scope.source.value,scope.target.value,scope.filter))}),scope.$watch("xindex",function(a,b){a!==b&&(scope.source=a[0],scope.drawChart(scope.orderby,scope.source.value,scope.target.value,scope.filter))}),scope.$watch("sort",function(a,b){a!==b&&(scope.orderby=a,scope.drawChart(scope.orderby,scope.source.value,scope.target.value,scope.filter))}),scope.$watch("filt",function(a,b){a!==b&&(scope.whichdata=a,scope.drawChart(scope.orderby,scope.source.value,scope.target.value,scope.filter))}),scope.drawChart(scope.orderby,scope.source.value,scope.target.value,scope.filter)}scope.datafiles=[],scope.data,loadData()}}}}}]),angular.module("emapsApp").controller("DatasetsCtrl",["$scope","content","$anchorScroll","$location",function(a,b){a.content=b}]),angular.module("emapsApp").directive("singleimage",["fileService","$compile",function(a){return{replace:!1,template:"<div class='img-narrative'></div>",restrict:"A",link:function(b,c,d){var e=c.find(".img-narrative"),f=JSON.parse(d.source)[0].url.split(".");return f=f[f.length-1].toLowerCase(),"jpg"===f||"png"===f?void e.append('<img src="'+JSON.parse(d.source)[0].url+'"/>'):void a.getFile(JSON.parse(d.source)[0].url).then(function(a){e.html(a)},function(a){var b=a;e.html(b)})}}}]),angular.module("emapsApp").directive("disqus",["$window","$location","$timeout","DISQUS_SHORTNAME",function(a,b,c,d){return{restrict:"E",scope:{disqus_shortname:"@disqusShortname",disqus_identifier:"@disqusIdentifier",disqus_title:"@disqusTitle",disqus_url:"@disqusUrl",disqus_category_id:"@disqusCategoryId",disqus_disable_mobile:"@disqusDisableMobile",readyToBind:"@"},template:'<div id="disqus_thread"></div><a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>',link:function(c){if("undefined"==typeof c.disqus_identifier)throw"Please ensure that the `disqus-identifier` attribute is set.";c.$watch("readyToBind",function(e){if(angular.isDefined(e)||(e="true"),c.$eval(e))if(a.disqus_shortname=c.disqus_shortname||d,a.disqus_identifier=c.disqus_identifier,a.disqus_title=c.disqus_title,a.disqus_url=b.absUrl(),a.disqus_category_id=c.disqus_category_id,a.disqus_disable_mobile=c.disqus_disable_mobile,a.DISQUS)$(".at-view-fade-in").on("$animate:close",function(){a.DISQUS.reset({reload:!0,config:function(){this.page.identifier=c.disqus_identifier,this.page.url=b.absUrl(),this.page.title=c.disqus_title}})});else{var f=document.createElement("script");f.type="text/javascript",f.async=!0;var g=c.disqus_shortname||d;f.src="//"+g+".disqus.com/embed.js",(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(f)}})}}}]),angular.module("emapsApp").constant("DISQUS_SHORTNAME","climapsplatform").constant("GA_ID","UA-5816319-10"),angular.module("emapsApp").directive("analytics",["GA_ID",function(a){return{restrict:"A",link:function(){!function(a,b,c,d,e,f,g){a.GoogleAnalyticsObject=e,a[e]=a[e]||function(){(a[e].q=a[e].q||[]).push(arguments)},a[e].l=1*new Date,f=b.createElement(c),g=b.getElementsByTagName(c)[0],f.async=1,f.src=d,g.parentNode.insertBefore(f,g)}(window,document,"script","//www.google-analytics.com/analytics.js","ga"),ga("create",a)}}}]);